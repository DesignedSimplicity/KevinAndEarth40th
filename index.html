<!DOCTYPE html>
<html>
<head>
  <title>3D Earth D3 Demo</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link href="/styles/demo.css" rel="stylesheet">
  <script src="/scripts/lib/d3-geo-projection.v2.js"></script>
  <script src="/scripts/lib/d3-zoom.v1.js"></script>
  <script src="/scripts/lib/d3.v5.js"></script>
  <script src="/scripts/lib/topojson.v3.js"></script>
  <style>
      #root {
          width: 90%;
          margin: 0 auto;
      }

      #space {
          position: relative;
          width: 100%;
      }

      #space:after {
          content: "";
          display: block;
          padding-bottom: 100%;
      }

      #earth {
          overflow: hidden;
          position: absolute;
          width: 100%;
          height: 100%;
          background: #111;
      }

      .geocountry {
        fill: #222;
        stroke: #777;
      }

      .geocountry:hover {
        fill: #333;
        stroke: #777;
      }

      .geovisited {
        fill: #030;
        stroke: #060;
      }

      .geovisited:hover {
        fill: #090;
        stroke: #0c0;
      }

      .geovisited:active {
        fill: #0c0;
        stroke: #0f0;
      }
  </style>
</head>
<body>
    <h1 id="title">3D Earth D3 Demo</h1>
    <div id="root">
        <div id="space">
            <div id="earth">
            </div>
        </div>
    </div>

    <script>
        // reference data
        var visitedCountires = [858, 392, 124, 10, 32, 76, 152, 36, 40, 56, 156, 250, 276, 344, 356, 372, 380, 388, 484, 496, 528, 554, 643, 702, 724, 826, 840];

        // main render output
        var divWorld = null;
        var svgWorld = null;

        // topo data cache
        var topoWorld = null;
        var worldFeature = null;
        
        // call event handlers
        var dragCall = null;
        var zoomCall = null;

        // load and render globe
        async function loadWorld() {
            // load required topo json data
            topoWorld = await d3.json("/data/topo/world.json");

            // render countries on globe
            worldFeature = topojson.feature(topoWorld, topoWorld.objects.countries);
            svgWorld.on("click", (d) => clickCountry(d));
            svgWorld.selectAll(".geocountry")
                .data(worldFeature.features)
                .enter()
                .insert("path")
                .attr("d", pathEarth)
                .attr("id", (d) => "g" + d.id)
                .attr("class", (d) => styleCountry(d))
                .on("mouseover", (d) => hoverCountry(d))
                .on("click", (d) => clickCountry(d));
        }

        function styleCountry(d) {
            return "geocountry" + (visitedCountires.includes(parseInt(d.id)) ? " geovisited" : "");
        }

        function hoverCountry(d) {
            //document.getElementById("title").innerHTML = "Country #" + d.id;
        }

        var activeCountry = 0;
        function clickCountry(d) {
            // prevent default click handler
            d3.event.stopPropagation();
            if (d) {
                // set selection
                activeCountry = d.id;
                // find x/y center of object
                var c = pathEarth.centroid(d);
                // map x/y to lat/lon
                var i = projEarth.invert(c);
                // invert for rotation
                projEarth.rotate([-i[0], -i[1]]);
                // refresh render            
                renderWorld();
                // zoom in
                zoomTo(2);
                // log out
                console.log(activeCountry);
            }
            else {
                // clear selection
                activeCountry = 0;
                // reset zoom level
                zoomTo(1);
            }
        }

        function renderWorld() {
            svgWorld.selectAll(".geocountry").attr("d", pathEarth);
        }

        // init d3
        var space = document.getElementById("space");
        var width = space.offsetWidth;
        var height = space.offsetHeight;
        var minSize = (height < width ? height : width);
        var scale = (minSize / 2);

        // root SVG to render all paths
        svgWorld = d3.select("#earth")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        dragCall = d3.drag()
            .on("start", () => dragWorld(true))
            .on("drag", () => dragWorld(false))
            .on("end", function () {
                //console.log(projEarth.rotate());
            });
        svgWorld.call(dragCall);

        zoomCall = d3.zoom()
            //.duration(1000)
            //.wheelDelta(() => (-0.1 * d3.event.deltaY))
            .on("zoom", () => zoomWorld());
        svgWorld.call(zoomCall)
            .on("wheel.zoom", null) // disable wheel zoom
            .on("dblclick.zoom", null); // disable double click

        // projection used for globe
        var projEarth = d3.geoOrthographic()
            .translate([width / 2, height / 2])
            .clipAngle(90)
            .scale(scale);

        // render path used for globe
        var pathEarth = d3.geoPath().projection(projEarth); //.pointRadius(2);

        // projection used for flights = globe * 1.25 to offset arcs above surface
        var projFlights = d3.geoOrthographic()
            .translate([width / 2, height / 2])
            .clipAngle(90)
            .scale(scale * 1.25);

        // load topojson data for world
        loadWorld();

        // configure drag globe
        var dragMouse = [0, 0];
        var dragPoint = [0, 0];
        function dragWorld(start) {
            var mouse = [d3.event.sourceEvent.pageX, d3.event.sourceEvent.pageY];
            if (d3.event.sourceEvent.changedTouches != null && d3.event.sourceEvent.changedTouches.length > 0) {
                mouse = [d3.event.sourceEvent.changedTouches[0].pageX, d3.event.sourceEvent.changedTouches[0].pageY];
            }

            if (start) {
                dragMouse = mouse;
                dragPoint = projEarth.rotate();
            }
            else {
                var x = mouse[0] - dragMouse[0];
                var y = mouse[1] - dragMouse[1];
                var point = [dragPoint[0] + (mouse[0] - dragMouse[0]) / 4, dragPoint[1] + (dragMouse[1] - mouse[1]) / 4];
                projEarth.rotate([point[0], point[1]]);
                renderWorld();
            }
        }

        function zoomWorld() {
            transform(d3.event.transform.k);
        }

        function zoomTo(level) {
            var transform = d3.zoomTransform(svgWorld);
            transform.k = level;
            svgWorld.attr("transform", transform);
        }
    </script>
</body>
</html>